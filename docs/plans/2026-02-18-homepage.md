# Homepage — Trail List Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Replace the `/` import page with a trail list homepage; move import to `/import`; add `TrailSummaryDto` with aggregated stats.

**Architecture:** Add `TrailSummaryDto` (id, name, totalDistance, startAt, endAt) to the core port and implement via a single SQL JOIN in `PgliteTrailRepository.listTrailSummaries()`. A new `use-trails` hook fetches summaries for the list page. The existing import UI moves verbatim to a new `/import` route.

**Tech Stack:** TypeScript, React, TanStack Router (file-based), PGlite (in-browser Postgres), Vitest

---

### Task 1: Add `TrailSummaryDto` to core and extend `TrailRepository` port

**Files:**
- Modify: `packages/core/src/application/models.ts`
- Modify: `packages/core/src/application/repositories.ts`
- Modify: `packages/core/src/index.ts`

**Step 1: Add `TrailSummaryDto` to models**

In `packages/core/src/application/models.ts`, add at the end:

```ts
export interface TrailSummaryDto {
  id: string
  name: string
  totalDistance: number   // km, sum across all activities
  startAt: number | null  // unix ms, earliest activity start_time
  endAt: number | null    // unix ms, latest activity end_time
}
```

**Step 2: Add `listTrailSummaries()` to `TrailRepository`**

In `packages/core/src/application/repositories.ts`, extend the `TrailRepository` interface:

```ts
export interface TrailRepository {
  createTrail(name: string): Promise<string>
  getTrail(id: string): Promise<TrailDto | null>
  listTrails(): Promise<TrailDto[]>
  listTrailSummaries(): Promise<TrailSummaryDto[]>
}
```

Also add the import at the top:

```ts
import type { TrailDto, TrailDayDto, ActivityDto, TrailSummaryDto } from './models.js'
```

**Step 3: Export `TrailSummaryDto` from core index**

In `packages/core/src/index.ts`, update the application ports export line:

```ts
export type { FileParser, ParsedActivity, TrailDto, TrailDayDto, ActivityDto, TrailSummaryDto, TrailRepository, TrailDayRepository, ActivityRepository, TrackpointRepository } from './application/ports.js'
```

**Step 4: Verify TypeScript compiles**

```bash
pnpm --filter @traildiary/core build 2>&1 || echo "check errors"
```

Expected: no errors (or type errors in `@traildiary/db` because `PgliteTrailRepository` now doesn't implement `listTrailSummaries` — that's fine, it will be fixed in Task 2).

**Step 5: Commit**

```bash
git add packages/core/src/application/models.ts packages/core/src/application/repositories.ts packages/core/src/index.ts
git commit -m "feat(core): add TrailSummaryDto and listTrailSummaries to TrailRepository port"
```

---

### Task 2: Implement `listTrailSummaries()` in `PgliteTrailRepository` with test

**Files:**
- Modify: `packages/db/src/infrastructure/trail-repository.ts`
- Modify: `packages/db/src/__tests__/infrastructure/repositories.test.ts`

**Step 1: Write the failing test**

In `packages/db/src/__tests__/infrastructure/repositories.test.ts`, add a new `describe` block after the existing ones. You'll need to also import `PgliteActivityRepository` and create activity records to test aggregation. Add these imports at the top if not present:

```ts
import { PgliteActivityRepository } from '../../infrastructure/activity-repository.js'
```

Then add the test:

```ts
describe('listTrailSummaries', () => {
  let db: PGlite

  beforeAll(async () => {
    db = new PGlite()
    await db.exec(MIGRATION_SQL)
  })

  afterAll(async () => {
    await db.close()
  })

  it('returns summaries with aggregated distance and startAt/endAt', async () => {
    const trailRepo = new PgliteTrailRepository(db)
    const dayRepo = new PgliteTrailDayRepository(db)
    const actRepo = new PgliteActivityRepository(db)

    const trailId = await trailRepo.createTrail('Alps 2025')
    const dayId = await dayRepo.createTrailDay(trailId, 'Day 1', 1)
    await actRepo.createActivity(dayId, 'Morning hike', 'gpx', {
      distance: 12.5,
      elevationGain: 800,
      elevationLoss: 200,
      duration: 14400000,
      movingTime: 13000000,
      avgSpeed: 3.5,
      startTime: 1700000000000,
      endTime: 1700014400000,
    }, 1)

    const summaries = await trailRepo.listTrailSummaries()
    const summary = summaries.find((s) => s.id === trailId)

    expect(summary).toBeDefined()
    expect(summary!.name).toBe('Alps 2025')
    expect(summary!.totalDistance).toBeCloseTo(12.5, 1)
    expect(summary!.startAt).toBe(1700000000000)
    expect(summary!.endAt).toBe(1700014400000)
  })

  it('returns null startAt/endAt for trail with no activities', async () => {
    const trailRepo = new PgliteTrailRepository(db)
    const trailId = await trailRepo.createTrail('Empty Trail')

    const summaries = await trailRepo.listTrailSummaries()
    const summary = summaries.find((s) => s.id === trailId)

    expect(summary).toBeDefined()
    expect(summary!.totalDistance).toBe(0)
    expect(summary!.startAt).toBeNull()
    expect(summary!.endAt).toBeNull()
  })
})
```

**Step 2: Run test to verify it fails**

```bash
pnpm --filter @traildiary/db test
```

Expected: FAIL — `listTrailSummaries is not a function`

**Step 3: Implement `listTrailSummaries()` in `PgliteTrailRepository`**

In `packages/db/src/infrastructure/trail-repository.ts`, add the import for `TrailSummaryDto` and implement the method:

```ts
import type { TrailRepository, TrailDto, TrailSummaryDto } from '@traildiary/core'
```

Add the method to the class:

```ts
async listTrailSummaries(): Promise<TrailSummaryDto[]> {
  const result = await this.db.query<{
    id: string
    name: string
    total_distance: number | null
    start_at: string | null
    end_at: string | null
  }>(
    `SELECT
       t.id,
       t.name,
       COALESCE(SUM(a.distance_km), 0) AS total_distance,
       MIN(EXTRACT(EPOCH FROM a.start_time) * 1000) AS start_at,
       MAX(EXTRACT(EPOCH FROM a.end_time) * 1000)   AS end_at
     FROM trails t
     LEFT JOIN trail_days td ON td.trail_id = t.id
     LEFT JOIN activities  a  ON a.trail_day_id = td.id
     GROUP BY t.id, t.name
     ORDER BY t.created_at DESC`
  )
  return result.rows.map((r) => ({
    id: r.id,
    name: r.name,
    totalDistance: r.total_distance ?? 0,
    startAt: r.start_at != null ? Math.round(Number(r.start_at)) : null,
    endAt: r.end_at != null ? Math.round(Number(r.end_at)) : null,
  }))
}
```

**Step 4: Run tests to verify they pass**

```bash
pnpm --filter @traildiary/db test
```

Expected: all tests PASS

**Step 5: Commit**

```bash
git add packages/db/src/infrastructure/trail-repository.ts packages/db/src/__tests__/infrastructure/repositories.test.ts
git commit -m "feat(db): implement listTrailSummaries with aggregated stats via SQL JOIN"
```

---

### Task 3: Create `use-trails` hook

**Files:**
- Create: `apps/web/src/application/hooks/use-trails.ts`

**Step 1: Create the hook**

```ts
import { useEffect, useState } from 'react'
import type { TrailSummaryDto } from '@traildiary/core'
import { useDb } from '../providers/db-provider.js'
import { createRepositories } from '../../infrastructure/di.js'

export function useTrails() {
  const db = useDb()
  const [trails, setTrails] = useState<TrailSummaryDto[]>([])
  const [loading, setLoading] = useState(true)

  useEffect(() => {
    let cancelled = false
    async function load() {
      const repos = createRepositories(db)
      const summaries = await repos.trails.listTrailSummaries()
      if (!cancelled) {
        setTrails(summaries)
        setLoading(false)
      }
    }
    load()
    return () => { cancelled = true }
  }, [db])

  return { trails, loading }
}
```

**Step 2: Verify TypeScript is happy**

```bash
pnpm --filter @traildiary/web build 2>&1 | head -30
```

Expected: no type errors in the new hook (there may be build errors elsewhere — that's fine for now).

**Step 3: Commit**

```bash
git add apps/web/src/application/hooks/use-trails.ts
git commit -m "feat(web): add use-trails hook for trail list summaries"
```

---

### Task 4: Move import UI to `/import` route

**Files:**
- Create: `apps/web/src/routes/import.tsx`

TanStack Router uses file-based routing. A file at `routes/import.tsx` maps to the `/import` path.

**Step 1: Create `apps/web/src/routes/import.tsx`**

Copy the current `routes/index.tsx` content verbatim, changing only the route definition:

```tsx
import { createFileRoute } from '@tanstack/react-router'
import { useState } from 'react'
import { FileDropZone } from '../ui/components/file-drop-zone.js'
import { useImport } from '../application/hooks/use-import.js'

export const Route = createFileRoute('/import')({
  component: ImportPage,
})

function ImportPage() {
  const { importFiles, progress } = useImport()
  const [files, setFiles] = useState<File[]>([])
  const [trailName, setTrailName] = useState('')

  const handleFiles = (newFiles: File[]) => {
    setFiles(newFiles)
    if (!trailName) {
      const prefix = newFiles[0]?.name.replace(/[_\s]\d+.*$/, '') ?? 'My Trail'
      setTrailName(prefix)
    }
  }

  const handleImport = () => {
    if (files.length === 0 || !trailName) return
    importFiles(trailName, files)
  }

  const isImporting = progress.status === 'parsing' || progress.status === 'saving'

  return (
    <div className="flex items-center justify-center h-full">
      <div className="w-full max-w-lg flex flex-col gap-6 p-8">
        <FileDropZone onFiles={handleFiles} disabled={isImporting} />

        {files.length > 0 && (
          <div className="flex flex-col gap-4">
            <input
              type="text"
              value={trailName}
              onChange={(e) => setTrailName(e.target.value)}
              placeholder="Trail name"
              className="px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-100"
            />
            <p className="text-sm text-gray-400">{files.length} file(s) selected</p>
            <button
              onClick={handleImport}
              disabled={isImporting}
              className="px-6 py-2 bg-blue-600 hover:bg-blue-500 disabled:bg-gray-700 rounded-lg font-medium transition-colors"
            >
              {isImporting ? `${progress.message} (${progress.current}/${progress.total})` : 'Import'}
            </button>
          </div>
        )}
      </div>
    </div>
  )
}
```

**Step 2: Register the new route in TanStack Router**

TanStack Router with file-based routing uses a generated route tree. Check if there is a `routeTree.gen.ts` or similar auto-generated file:

```bash
ls apps/web/src/
```

If `routeTree.gen.ts` exists: the router auto-generates it from files. You may need to run `pnpm dev` once to trigger regeneration, or run the TanStack Router CLI:

```bash
pnpm --filter @traildiary/web exec tsr generate
```

If the route tree is manually maintained (no auto-generation), look for where routes are registered (likely `main.tsx` or `router.tsx`) and add the import route.

**Step 3: Commit**

```bash
git add apps/web/src/routes/import.tsx
git commit -m "feat(web): add /import route with existing import UI"
```

---

### Task 5: Rewrite `/` as the trail list homepage

**Files:**
- Modify: `apps/web/src/routes/index.tsx`

**Step 1: Replace `routes/index.tsx` with the trail list**

```tsx
import { createFileRoute, Link } from '@tanstack/react-router'
import { useTrails } from '../application/hooks/use-trails.js'

export const Route = createFileRoute('/')({
  component: HomePage,
})

function HomePage() {
  const { trails, loading } = useTrails()

  return (
    <div className="h-full overflow-y-auto">
      <div className="max-w-2xl mx-auto px-4 py-8 flex flex-col gap-6">
        <div className="flex items-center justify-between">
          <h2 className="text-xl font-semibold">My Trails</h2>
          <Link
            to="/import"
            className="px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded-lg text-sm font-medium transition-colors"
          >
            New Trail
          </Link>
        </div>

        {loading && (
          <p className="text-gray-400 text-sm">Loading…</p>
        )}

        {!loading && trails.length === 0 && (
          <div className="flex flex-col items-center gap-4 py-16 text-center">
            <p className="text-gray-400">No trails yet.</p>
            <Link
              to="/import"
              className="text-blue-400 hover:text-blue-300 underline text-sm"
            >
              Import your first trail
            </Link>
          </div>
        )}

        {!loading && trails.length > 0 && (
          <ul className="flex flex-col gap-3">
            {trails.map((trail) => (
              <li key={trail.id}>
                <Link
                  to="/trail/$trailId"
                  params={{ trailId: trail.id }}
                  className="block bg-gray-900 hover:bg-gray-800 border border-gray-800 rounded-xl px-5 py-4 transition-colors"
                >
                  <div className="flex items-baseline justify-between gap-4">
                    <span className="font-medium text-gray-100 truncate">{trail.name}</span>
                    <span className="text-sm text-gray-400 shrink-0">
                      {trail.totalDistance > 0
                        ? `${trail.totalDistance.toFixed(1)} km`
                        : '—'}
                    </span>
                  </div>
                  {trail.startAt != null && (
                    <p className="mt-1 text-sm text-gray-500">
                      {new Date(trail.startAt).toLocaleDateString(undefined, {
                        year: 'numeric', month: 'short', day: 'numeric',
                      })}
                    </p>
                  )}
                </Link>
              </li>
            ))}
          </ul>
        )}
      </div>
    </div>
  )
}
```

**Step 2: Regenerate route tree if needed**

```bash
pnpm --filter @traildiary/web exec tsr generate
```

Or start dev server once to trigger auto-generation.

**Step 3: Verify app builds**

```bash
pnpm --filter @traildiary/web build 2>&1 | tail -20
```

Expected: build succeeds with no type errors.

**Step 4: Run all tests**

```bash
pnpm test
```

Expected: all existing tests pass.

**Step 5: Commit**

```bash
git add apps/web/src/routes/index.tsx
git commit -m "feat(web): homepage shows trail list, import moved to /import"
```
